# Домашнее задание 4 #
## Работа с базами данных, пользователями и правами ##

**Цель:**

   + создание новой базы данных, схемы и таблицы
   + создание роли для чтения данных из созданной схемы созданной базы данных
   + создание роли для чтения и записи из созданной схемы созданной базы данных

       1. создайте новый кластер PostgresSQL 13 (на выбор - GCE, CloudSQL)
       2. зайдите в созданный кластер под пользователем postgres
       3. создайте новую базу данных testdb
       4. зайдите в созданную базу данных под пользователем postgres
       5. создайте новую схему testnm
       6. создайте новую таблицу t1 с одной колонкой c1 типа integer
       7. вставьте строку со значением c1=1
       8. создайте новую роль readonly
       9. дайте новой роли право на подключение к базе данных test

    GRANT CONNECT ON DATABASE testdb TO readonly;

       10. дайте новой роли право на использование схемы testnm

    GRANT USAGE ON SCHEMA testnm TO readonly;

       11. дайте новой роли право на select для всех таблиц схемы testnm

    GRANT SELECT ON ALL TABLES IN SCHEMA testnm TO readonly;

       12. создайте пользователя testread с паролем test123

    CREATE USER testread PASSWORD 'test123'; - пишет CREATE ROLE забавно

       13. дайте роль readonly пользователю testread

    GRANT readonly TO testread;

       14. зайдите под пользователем testread в базу данных testdb

    sudo -u postgres psql -U testread -h localhost -W -d testdb
  
       15. сделайте select * from t1;
       16. получилось? (могло если вы делали сами не по шпаргалке и не упустили один существенный момент про который позже)

Нет, не получилось. Т.к. в задании не было указана необходимость создания таблицы в схеме testnm. А так как параметр seach path не изменялся, то таблица была создана в схеме public доступ к котрой не выдавался.

       17. напишите что именно произошло в тексте домашнего задания
       18. у вас есть идеи почему? ведь права то дали?
       19. посмотрите на список таблиц
    \dt
       20. подсказка в шпаргалке под пунктом 20
       21. а почему так получилось с таблицей (если делали сами и без шпаргалки то может у вас все нормально)
       22. вернитесь в базу данных testdb под пользователем postgres
       23. удалите таблицу t1
       24. создайте ее заново но уже с явным указанием имени схемы testnm
       25. вставьте строку со значением c1=1
       26. зайдите под пользователем testread в базу данных testdb
       27. сделайте select * from testnm.t1;
       28. получилось?
       29. есть идеи почему? если нет - смотрите шпаргалку

Нужно заново выдать права на новые объекты - ALTER DEFAULT PRIVILEGES IN SCHEMA testnm grant SELECT ON TABLES TO readonly;

    30. как сделать так чтобы такое больше не повторялось? если нет идей - смотрите шпаргалку
    31. сделайте select * from testnm.t1;
    32. получилось?
    33. есть идеи почему? если нет - смотрите шпаргалку

Нет, так как ALTER DEFAULT PRIVILEGES не применился на объекты созднанные **ПОСЛЕ** выдачи этих прав, необходимо сделать это заново: GRANT SELECT ON ALL TABLES IN SCHEMA testnm TO readonly;

    31. сделайте select * from testnm.t1;
    32. получилось?

Да, получилось.

    33. ура!
    34. теперь попробуйте выполнить команду create table t2(c1 integer); insert into t2 values (2);
    35. а как так? нам же никто прав на создание таблиц и insert в них под ролью readonly?
    36. есть идеи как убрать эти права? если нет - смотрите шпаргалку
**Воспользовался подсказкой:**
 
`это все потому что search_path указывает в первую очередь на схему public. А схема public создается в каждой базе данных по умолчанию. И grant на все действия в этой схеме дается роли public. А роль public добавляется всем новым пользователям. Соответсвенно каждый пользователь может по умолчанию создавать объекты в схеме public любой базы данных, ес-но если у него есть право на подключение к этой базе данных. Чтобы раз и навсегда забыть про роль public - а в продакшн базе данных про нее лучше забыть - выполните следующие действия 
\c testdb postgres; 
revoke CREATE on SCHEMA public FROM public; 
revoke all on DATABASE testdb FROM public; 
\c testdb testread;`
    37. если вы справились сами то расскажите что сделали и почему, если смотрели шпаргалку - объясните что сделали и почему выполнив указанные в ней команды
    38. теперь попробуйте выполнить команду create table t3(c1 integer); insert into t2 values (2);

Ошибка создания таблицы, т.к. отобрали права в предыдущем пункте. Вставка в таблицу t2 прошла успешно, тк пользователь testread является ее владельцем по созданию.

    39. расскажите что получилось и почему 